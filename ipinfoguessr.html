<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IP Geolocation Guessing Game</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; position: absolute; }
    #info {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 300px;
    }
    #info select, #info button {
      margin-top: 10px;
      padding: 5px;
      width: 100%;
    }
    #modeSelector, #startButton {
      display: block;
    }
    #info.playing #modeSelector, #info.playing #startButton {
      display: none;
    }
    #scoreDisplay {
      font-weight: bold;
      margin-top: 10px;
    }
    #footer {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      font-size: 14px;
      text-align: center;
      z-index: 999;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div id="info">
  <div id="status">Click Start Game to begin</div>
  <select id="modeSelector">
    <option value="">Choose Mode</option>
    <option value="normal">Normal Mode</option>
    <option value="hard">Hard Mode</option>
  </select>
  <button id="startButton" onclick="startGame()">Start Game</button>
  <div id="result"></div>
  <div id="scoreDisplay">Total Score: 0</div>
</div>
<div id="footer">
  Guess where the IP is located by clicking on the map.<br>
  The closer your guess, the higher your score.<br>
  You can keep playing in your selected mode until the page is reloaded.<br>
  <strong>Data powered by <a href="https://ipinfo.io" target="_blank">IPinfo.io</a></strong><br>
  <div id="lastIpLink"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([20, 0], 2);
L.tileLayer('https://tiles.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
  maxZoom: 18
}).addTo(map);

let currentScore = 0;
let ipAddress = '';
let realLocation = null;
let previousIpAddress = null;
let guessedItems = [];
let currentMode = localStorage.getItem('ipGuessMode') || '';

const modeSelector = document.getElementById('modeSelector');
modeSelector.value = currentMode;

modeSelector.addEventListener('change', () => {
  currentMode = modeSelector.value;
  localStorage.setItem('ipGuessMode', currentMode);
});

const infoDiv = document.getElementById('info');
const scoreDisplay = document.getElementById('scoreDisplay');

async function startGame() {
  if (!currentMode) {
    alert("Please select a mode before starting the game.");
    return;
  }

  clearMap();
  document.getElementById('result').innerHTML = '';
  document.getElementById('status').innerText = 'Fetching a new IP...';
  infoDiv.classList.add('playing');

  const data = await fetchValidIPLocation();
  if (!data) {
    document.getElementById('status').innerText = 'Failed to load IP info. Try again.';
    return;
  }

  // Update the last IP address link if there's a previous one
  if (previousIpAddress) {
    document.getElementById('lastIpLink').innerHTML = `Last IP address: <a href="https://ipinfo.io/${previousIpAddress}" target="_blank">${previousIpAddress}</a>`;
  } else {
    document.getElementById('lastIpLink').innerHTML = '';
  }

  previousIpAddress = data.ip;
  ipAddress = data.ip;
  realLocation = data.loc.split(',').map(Number);

  let details = `IP: <strong>${ipAddress}</strong><br>ASN: ${data.org || 'N/A'}<br>`;
  if (currentMode === 'normal') {
    details += `AS Name: ${data.org?.split(' ').slice(1).join(' ') || 'N/A'}<br>`;
    if (data.hostname) {
      details += `Hostname: ${data.hostname}<br>`;
    }
  }

  document.getElementById('status').innerHTML = details + 'Click on the map to drop your pin.';
}

async function fetchValidIPLocation() {
  for (let i = 0; i < 15; i++) {
    const ip = getRandomIP();
    try {
      const res = await fetch(`https://ipinfo.io/${ip}/json`);
      const data = await res.json();
      if (!data.bogon && data.loc) {
        return data;
      }
    } catch (e) {
      continue;
    }
  }
  return null;
}

function getRandomIP() {
  const octet = () => Math.floor(Math.random() * 256);
  return `${octet()}.${octet()}.${octet()}.${octet()}`;
}

function clearMap() {
  guessedItems.forEach(item => map.removeLayer(item));
  guessedItems.length = 0;
}

function haversineDistance(lat1, lon1, lat2, lon2) {
  const toRad = deg => deg * Math.PI / 180;
  const R = 6371;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function scoreFromDistance(km) {
  if (km < 100) return 100;
  if (km < 500) return 75;
  if (km < 1000) return 50;
  if (km < 2000) return 25;
  return 10;
}

map.on('click', function(e) {
  if (!realLocation) return;

  const guessLatLng = [e.latlng.lat, e.latlng.lng];
  const markerGuess = L.marker(guessLatLng, {icon: L.icon({iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png', iconSize: [24, 24]})}).addTo(map);
  const markerReal = L.marker(realLocation, {icon: L.icon({iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png', iconSize: [24, 24]})}).addTo(map);

  const line = L.polyline([guessLatLng, realLocation], {color: 'green', dashArray: '5,10'}).addTo(map);
  guessedItems.push(markerGuess, markerReal, line);

  const distance = haversineDistance(...guessLatLng, ...realLocation);
  const score = scoreFromDistance(distance);
  currentScore += score;

  document.getElementById('result').innerHTML = `You were <strong>${distance.toFixed(1)} km</strong> away. You earned <strong>${score}</strong> points.`;
  scoreDisplay.innerText = `Total Score: ${currentScore}`;
  document.getElementById('status').innerText = '';
  realLocation = null;

  setTimeout(startGame, 5000);
});
</script>
</body>
</html>
