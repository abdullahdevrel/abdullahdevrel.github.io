<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traceroute Visualizer - IPinfo DevRel</title>
    <link rel="icon" type="image/png" href="../images/logo.png">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .header {
            background: #2c3e50;
            color: white;
            text-align: center;
            padding: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #555;
        }

        .traceroute-input {
            width: 100%;
            height: 200px;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .server-ip-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
            transition: border-color 0.3s ease;
        }

        .server-ip-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .traceroute-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }

        .button:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress {
            margin: 20px 0;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: #3498db;
            width: 0%;
            transition: width 0.3s ease;
        }

        .results {
            margin-top: 30px;
            display: none;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .results-table th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e1e5e9;
        }

        .results-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .map-container {
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        .status.info {
            background: #e8f4fd;
            color: #2980b9;
            border-left: 4px solid #3498db;
        }

        .status.error {
            background: #fdf2f2;
            color: #c0392b;
            border-left: 4px solid #e74c3c;
        }

        .status.success {
            background: #eafaf1;
            color: #27ae60;
            border-left: 4px solid #2ecc71;
        }

        .example {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .example h3 {
            margin-bottom: 10px;
            color: #555;
        }

        .example pre {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            color: #666;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåç Traceroute Visualizer</h1>
            <p>Visualize network paths with geographic data from IPinfo</p>
        </div>
        
        <div class="content">
            <div class="input-section">
                <label for="server-ip">Server IP Address (Optional):</label>
                <input type="text" id="server-ip" class="server-ip-input" 
                       placeholder="Enter your server's IP address (e.g., 192.168.1.100)">
                <small style="color: #666; font-size: 13px; margin-top: 5px; display: block;">
                    This will be shown as Hop 0 in your traceroute visualization
                </small>
                
                <label for="traceroute-input" style="margin-top: 20px;">Paste your traceroute output:</label>
                <textarea id="traceroute-input" class="traceroute-input" 
                          placeholder="Paste your traceroute output here...&#10;&#10;Example:&#10;traceroute to google.com (142.250.191.14), 30 hops max, 60 byte packets&#10; 1  192.168.1.1 (192.168.1.1)  1.234 ms  1.123 ms  1.045 ms&#10; 2  10.0.0.1 (10.0.0.1)  5.678 ms  5.432 ms  5.234 ms&#10; 3  * * *&#10; 4  8.8.8.8 (8.8.8.8)  15.123 ms  15.045 ms  14.987 ms"></textarea>
                
                <button id="analyze-btn" class="button">üîç Analyze Route</button>
                
                <div id="progress" class="progress">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>
                
                <div id="status" class="status"></div>
            </div>

            <div id="results" class="results">
                <h2>Route Analysis Results</h2>
                <table id="results-table" class="results-table">
                    <thead>
                        <tr>
                            <th>Hop</th>
                            <th>IP Address</th>
                            <th>Hostname</th>
                            <th>Location</th>
                            <th>ISP</th>
                            <th>Response Time</th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody">
                    </tbody>
                </table>
                
                <h3>Route Map</h3>
                <div id="map" class="map-container"></div>
            </div>

            <div class="example">
                <h3>üí° How to use:</h3>
                <ol>
                    <li><strong>Optional:</strong> Enter your server's IP address to show it as Hop 0</li>
                    <li>Run a traceroute command in your terminal: <code>traceroute google.com</code></li>
                    <li>Copy the entire output and paste it in the text area above</li>
                    <li>Click "Analyze Route" to see the geographic path visualization</li>
                    <li>View the results table and interactive map showing your network path</li>
                </ol>
                
                <h3>üìã Example traceroute output:</h3>
                <pre>traceroute to google.com (142.250.191.14), 30 hops max, 60 byte packets
 1  192.168.1.1 (192.168.1.1)  1.234 ms  1.123 ms  1.045 ms
 2  10.0.0.1 (10.0.0.1)  5.678 ms  5.432 ms  5.234 ms
 3  * * *
 4  72.14.204.1 (72.14.204.1)  12.123 ms  12.045 ms  11.987 ms
 5  142.250.191.14 (142.250.191.14)  15.456 ms  15.234 ms  15.123 ms</pre>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        class TracerouteAnalyzer {
            constructor() {
                this.map = null;
                this.markers = [];
                this.polylines = [];
                this.results = [];
                
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                document.getElementById('analyze-btn').addEventListener('click', () => {
                    this.analyzeTraceroute();
                });
            }

            showStatus(message, type = 'info') {
                const statusEl = document.getElementById('status');
                statusEl.textContent = message;
                statusEl.className = `status ${type}`;
                statusEl.style.display = 'block';
            }

            hideStatus() {
                document.getElementById('status').style.display = 'none';
            }

            showProgress() {
                document.getElementById('progress').style.display = 'block';
            }

            hideProgress() {
                document.getElementById('progress').style.display = 'none';
            }

            updateProgress(percent) {
                document.getElementById('progress-bar').style.width = `${percent}%`;
            }

            async analyzeTraceroute() {
                const input = document.getElementById('traceroute-input').value.trim();
                const serverIP = document.getElementById('server-ip').value.trim();
                
                if (!input) {
                    this.showStatus('Please paste traceroute output first.', 'error');
                    return;
                }

                const analyzeBtn = document.getElementById('analyze-btn');
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = 'üîÑ Analyzing...';

                this.showProgress();
                this.showStatus('Parsing traceroute output...', 'info');
                this.updateProgress(10);

                try {
                    // Parse traceroute output
                    const hops = this.parseTraceroute(input);
                    this.updateProgress(20);

                    // Add server IP as hop 0 if provided and valid
                    let allHops = [...hops];
                    if (serverIP && this.isValidIP(serverIP)) {
                        allHops.unshift({
                            hop: 0,
                            ip: serverIP,
                            hostname: serverIP,
                            responseTime: 'N/A'
                        });
                        this.showStatus('Added server IP as Hop 0. Processing remaining hops...', 'info');
                    }
                    this.updateProgress(30);

                    if (allHops.length === 0) {
                        throw new Error('No valid hops found in traceroute output');
                    }

                    this.showStatus(`Found ${allHops.length} hops. Getting location data...`, 'info');

                    // Get location data for each hop
                    this.results = [];
                    for (let i = 0; i < allHops.length; i++) {
                        const hop = allHops[i];
                        this.showStatus(`Processing hop ${hop.hop}/${Math.max(...allHops.map(h => h.hop))}: ${hop.ip}`, 'info');
                        
                        try {
                            const locationData = await this.getLocationData(hop.ip);
                            this.results.push({
                                ...hop,
                                ...locationData
                            });
                        } catch (error) {
                            console.warn(`Failed to get location for ${hop.ip}:`, error);
                            this.results.push({
                                ...hop,
                                city: 'Unknown',
                                region: 'Unknown',
                                country: 'Unknown',
                                latitude: null,
                                longitude: null,
                                org: 'Unknown'
                            });
                        }

                        this.updateProgress(30 + (i + 1) / allHops.length * 50);
                    }

                    this.showStatus('Rendering results...', 'info');
                    this.updateProgress(90);

                    // Sort results by hop number to ensure proper order
                    this.results.sort((a, b) => a.hop - b.hop);

                    // Display results
                    this.displayResults();
                    this.createMap();

                    this.showStatus(`Successfully analyzed ${this.results.length} hops!`, 'success');
                    this.updateProgress(100);

                    setTimeout(() => {
                        this.hideProgress();
                        this.hideStatus();
                    }, 2000);

                } catch (error) {
                    console.error('Analysis error:', error);
                    this.showStatus(`Error: ${error.message}`, 'error');
                    this.hideProgress();
                } finally {
                    analyzeBtn.disabled = false;
                    analyzeBtn.textContent = 'üîç Analyze Route';
                }
            }

            parseTraceroute(input) {
                const lines = input.split('\n');
                const hops = [];
                
                for (const line of lines) {
                    // Skip header lines and empty lines
                    if (!line.trim() || line.includes('traceroute to') || line.includes('hops max')) {
                        continue;
                    }

                    // Skip lines with only asterisks
                    if (/^\s*\d+\s+\*\s*\*\s*\*/.test(line)) {
                        continue;
                    }

                    // Extract hop number, IP/hostname, and timing
                    const hopMatch = line.match(/^\s*(\d+)\s+([^\s\(]+)(?:\s+\(([^\)]+)\))?(.*)$/);
                    if (hopMatch) {
                        const hopNumber = parseInt(hopMatch[1]);
                        const target = hopMatch[2];
                        const ipInParens = hopMatch[3];
                        const timingPart = hopMatch[4] || '';

                        let ip, hostname;

                        // Determine if target is IP or hostname
                        if (this.isValidIP(target)) {
                            ip = target;
                            hostname = ipInParens || target;
                        } else {
                            hostname = target;
                            ip = ipInParens || target;
                        }

                        // Extract timing information
                        const timeMatches = timingPart.match(/(\d+(?:\.\d+)?)\s*ms/g);
                        let avgTime = 'N/A';
                        if (timeMatches && timeMatches.length > 0) {
                            const times = timeMatches.map(t => parseFloat(t.replace(' ms', '')));
                            const sum = times.reduce((a, b) => a + b, 0);
                            avgTime = (sum / times.length).toFixed(2) + ' ms';
                        }

                        // Validate IP address
                        if (this.isValidIP(ip)) {
                            hops.push({
                                hop: hopNumber,
                                ip: ip,
                                hostname: hostname,
                                responseTime: avgTime
                            });
                        }
                    }
                }

                return hops;
            }

            isValidIP(ip) {
                const ipv4Regex = /^(\d{1,3}\.){3}\d{1,3}$/;
                const ipv6Regex = /^([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$|^::1$|^::$/;
                
                if (ipv4Regex.test(ip)) {
                    // Validate IPv4 octets
                    const octets = ip.split('.');
                    return octets.every(octet => parseInt(octet) >= 0 && parseInt(octet) <= 255);
                }
                
                return ipv6Regex.test(ip);
            }

            async getLocationData(ip) {
                const response = await fetch(`https://ipinfo.io/${ip}/json`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Parse location coordinates
                let latitude = null, longitude = null;
                if (data.loc) {
                    const [lat, lon] = data.loc.split(',');
                    latitude = parseFloat(lat);
                    longitude = parseFloat(lon);
                }

                return {
                    city: data.city || 'Unknown',
                    region: data.region || 'Unknown',
                    country: data.country || 'Unknown',
                    latitude: latitude,
                    longitude: longitude,
                    org: data.org || 'Unknown'
                };
            }

            displayResults() {
                const tbody = document.getElementById('results-tbody');
                tbody.innerHTML = '';

                this.results.forEach(result => {
                    const row = document.createElement('tr');
                    const hopDisplay = result.hop === 0 ? `<strong>0 (Server)</strong>` : `<strong>${result.hop}</strong>`;
                    row.innerHTML = `
                        <td>${hopDisplay}</td>
                        <td><code>${result.ip}</code></td>
                        <td>${result.hostname}</td>
                        <td>${result.city}, ${result.region}, ${result.country}</td>
                        <td>${result.org}</td>
                        <td>${result.responseTime}</td>
                    `;
                    
                    // Add special styling for hop 0 (server)
                    if (result.hop === 0) {
                        row.style.backgroundColor = '#fff5f5';
                        row.style.borderLeft = '4px solid #e74c3c';
                    }
                    
                    tbody.appendChild(row);
                });

                document.getElementById('results').style.display = 'block';
            }

            createMap() {
                // Clear existing map
                if (this.map) {
                    this.map.remove();
                }

                // Initialize map
                this.map = L.map('map').setView([20, 0], 2);

                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(this.map);

                // Clear previous markers and polylines
                this.markers = [];
                this.polylines = [];

                // Add markers and create route
                const validHops = this.results.filter(result => 
                    result.latitude !== null && result.longitude !== null
                );

                if (validHops.length === 0) {
                    return;
                }

                // Create markers for each hop
                validHops.forEach((hop, index) => {
                    const marker = L.marker([hop.latitude, hop.longitude])
                        .addTo(this.map)
                        .bindPopup(`
                            <div style="text-align: center; min-width: 200px;">
                                <strong>Hop ${hop.hop}${hop.hop === 0 ? ' (Your Server)' : ''}</strong><br>
                                <div style="margin: 8px 0;">
                                    <a href="https://ipinfo.io/${hop.ip}" target="_blank" style="color: #3498db; text-decoration: none; font-weight: 600;">
                                        ipinfo.io/${hop.ip}
                                    </a>
                                </div>
                                <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin: 8px 0;">
                                    <strong>Response Time:</strong> ${hop.responseTime}
                                </div>
                                <div style="font-size: 12px; color: #666; line-height: 1.4;">
                                    <strong>Location:</strong> ${hop.city}, ${hop.region}, ${hop.country}<br>
                                    <strong>ISP:</strong> ${hop.org}
                                </div>
                            </div>
                        `);

                    // Add hop number label with special styling for hop 0
                    const isServerHop = hop.hop === 0;
                    const backgroundColor = isServerHop ? '#e74c3c' : '#3498db';
                    const divIcon = L.divIcon({
                        className: 'hop-label',
                        html: `<div style="background: ${backgroundColor}; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">${hop.hop}</div>`,
                        iconSize: [25, 25],
                        iconAnchor: [12, 12]
                    });

                    L.marker([hop.latitude, hop.longitude], { icon: divIcon })
                        .addTo(this.map);

                    this.markers.push(marker);
                });

                // Create route polyline
                if (validHops.length > 1) {
                    const coordinates = validHops.map(hop => [hop.latitude, hop.longitude]);
                    const polyline = L.polyline(coordinates, {
                        color: '#3498db',
                        weight: 3,
                        opacity: 0.7
                    }).addTo(this.map);

                    this.polylines.push(polyline);

                    // Fit map to show all points
                    this.map.fitBounds(polyline.getBounds(), { padding: [20, 20] });
                }
            }
        }

        // Initialize the analyzer when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new TracerouteAnalyzer();
        });
    </script>
</body>
</html>
